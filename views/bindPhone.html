<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script src="../js/rem_reset.js"></script>
		<link rel="stylesheet" href="../css/common.css">
		<link rel="stylesheet" href="../css/mobileReset.css">
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/pages/bindPhone.css" />
	</head>
	<body onselectstart="return false;">
		<div id="login">
			<!-- 返回按钮 -->
			<div class="returnKey mui-action-back">
				<img src="../image/33@2x2.png" style="width: .6rem;height: .6rem;">
			</div>
			
			
			<div class="content">
				<div class="" id="bindPhone" style="margin-left: .72rem;">
					<div class="bind_title" style="color: #FFFFFF;float: left;margin-top: 0.51rem;">
						绑定手机号
					</div>
					<div style="height: 1.65rem;"></div>
					
					<div class="ipt-style bindPhone_phone">
						<img src="../image/4538@2x.png" class="bindPhone_I">
						<input type="number" id="tel" maxlength="11" placeholder="请输入手机号" />
					</div>
					<div class="ipt-style bindPhone_code">
						<img src="../image/4539@2x.png" class="bindPhone_I" style="width: 0.3553rem;">
						<input type="number" id="code" maxlength="6" placeholder="请输入验证码" style="width: 60%;margin-top: 0.25rem;" />
						<span class="getcode" style="font-size: .26rem;color: #FFFFFF;margin-top: 0.1rem;margin-left: 0.5rem;margin-top: 0.26rem;">获取验证码</span>
					</div>
					<div class="bind_btn submit">
						确认绑定
					</div>
					
					<div class="use_car_des" style="margin-top: 0.2rem;margin-left: 0.7rem;">
						<p style="color: #6E6E6E;font-size: 0.24rem;">点击登录，即表示您同意<a href="#" data-index='0' style="color: #FFFFFF;font-size: 0.24rem;">《笑容用户协议》</a></p>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../js/jquery-1.11.2.min.js"></script>
	<script src="../js/mui.min.js"></script>
	<script src="../js/commonFun.js"></script>
	<script src="../js/requestFun.js" type="text/javascript" charset="utf-8"></script>
	<script>
		(function($, doc, $$, undefined) {
			$$.init();
			var _self,
				timer;
			if (window.plus) {
				plusReady();
			} else {
				doc.addEventListener('plusready', plusReady, false);
			}

			function plusReady() {
				plus.navigator.setFullscreen(false);
				//强制竖屏
				plus.screen.lockOrientation("portrait-primary");
				// 关闭上一个页面
				if (plus.webview.currentWebview().opener()) {
					plus.webview.currentWebview().opener().close();
				}
				//强制隐藏滚动条
				plus.webview.currentWebview().setStyle({
					scrollIndicator: 'none'
				});
				_self = plus.webview.currentWebview();
				
				// 服务条例
				$('.use_car_des').on('tap', 'a', function() {
					console.log($(this).attr('data-index'));
					var caseProtocol = $(this).attr('data-index');
					$$.openWindow({
						url: "../views/agreement.html",
						id: "agreement",
						styles: {
							statusbar: {
								background: "#fff"
							}
						}
					})
				})
				
				//是否可以点击【获取验证码按钮开关】
				var onOff = true,
					//code_4用于注册信息时的验证，验证码，获取与输入的一致
					code_4 = '';
				$('.getcode').on('tap', function() {
					if ($('#tel').val() < 11 || !(/^1[3456789]\d{9}$/.test($('#tel').val()))) {
						tipShow('请输入正确手机号');
						return
					}
					//如果onOff标志false则，不执行任何操作
					if (!onOff)
						return;
					//循环周期60s
					var tel = $('#tel').val(),
						telReg = /^1[3,4,5,6,7,8,9]\d{9}$/,
						times = 60;
					//发送短信验证码
					if (telReg.test(tel)) {
						var getCodeWati = plus.nativeUI.showWaiting("获取中...");
						var keyword = {
							openId: plus.storage.getItem('userOpenId'),
							phone: tel
						};
						getWXCode(mui, keyword, function(data) {
							getCodeWati.close();
							if (data.code == 200) {
								console.log('验证码获取成功' + data.data)
							} else {
								console.log('验证码获取失败' + data.message)
							}
						});
						//使用定时器，一秒触发一次事件，如果结束，则关闭定时器
						timer = setInterval(function() {
							//事件处理，一秒一次
							times--;
							if (times < 1) {
								//执行结束，则可以再次点击
								$('.getcode').html("重新获取");
								onOff = true;
								clearInterval(timer);
							} else {
								var text = times + 's';
								$('.getcode').html(text);
								onOff = false;
							}
						}, 1000);
					} else {
						$$.toast('请输入正确的手机号码')
						return
					}
				});
				//点击提交按钮跳转实名认证页
				$('.submit').on('tap', function() {
					var tel = $('#tel').val(),
						telCode = $('#code').val(),
						telReg = /^1[3,4,5,6,7,8,9]\d{9}$/,
						code = $('#code').val();
					if (!telReg.test(tel)) {
						$$.toast('请输入正确的手机号码')
						return
					} else if (code.length != 6) {
						$$.toast('请输入正确的验证码')
						return
					}
					var getoLogin = plus.nativeUI.showWaiting("登录中...");
					var keyword = {
						phone: tel,
						code: telCode,
						openId:plus.storage.getItem('userOpenId') || '',
						headImgUrl:plus.storage.getItem('wxHeadImg') || '',
						nickName:plus.storage.getItem('wxNickName') || ''
					}
					// 去登录
					getWXLogin(mui, keyword, function(data) {
						getoLogin.close();
						if (data.code == 200) {
							var ws=plus.webview.currentWebview();
							plus.webview.close(ws);
							plus.storage.setItem('memberId', data.data.id);
							plus.storage.setItem('Token', data.data.token + "")
							console.log('登录成功' + JSON.stringify(data))
						} else {
							tipShow(data.message)
							$("#code").val('') 
							console.log('登录失败' + data.message)
						}
					});
				});
				// 监听验证码输入框内容
				$('.bindPhone_code input').bind('input propertychange', function() {
					console.log($(this).val())
					if ($(this).val().length == 6) {
						$(".bind_btn").css({
							"backgroundColor": "red",
							"border": "#FF373D"
						});
					}
				});
			}

		})(jQuery, document, mui);
	</script>

</html>
