<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script src="../js/rem_reset.js"></script>
		<link rel="stylesheet" href="../css/common.css">
		<link rel="stylesheet" href="../css/mobileReset.css">
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/pages/bindPhone.css" />
	</head>
	<body onselectstart="return false;">
		<header class="header_white">
			<i class="mui-action-back"><img src="../image/left@2x.png" style="width: .6rem;height: .6rem;margin-left: .72rem;margin-top: .5rem;"></i>
			<!-- 绑定页面 -->
		</header>
		<div class="content" style="background-color: #FFFFFF;">
			<div class="" id="bindPhone" style="margin-left: .72rem;">
				<div class="bind_title" >
					绑定手机号
				</div>
				<div class="ipt-style" style="border-bottom: 1px solid #707070;width: 80%;margin-top: 1.2rem;">
					<img src="../image/position.png" style="width: .24rem;height: .35rem;">
					<input type="number" id="tel" maxlength="11" placeholder="请输入手机号" />
				</div>
				<div class="ipt-style" style="border-bottom: 1px solid #707070;width: 80%;margin-top: .7rem;">
					<img src="../image/position.png" style="width: .24rem;height: .35rem;">
					<input type="number" name="" id="" value="" placeholder="请输入手机号码" style="width: 64%;" />
					<span class="getcode" style="font-size: .3rem;color: #0C0C0C;">获取验证码</span>
				</div>
				<div class="bind_btn">
					确认绑定
				</div>
			</div>
		</div>
	</body>
	<script src="../js/jquery-1.11.2.min.js"></script>
	<script src="../js/mui.min.js"></script>
	<script src="../js/commonFun.js"></script>
	<script src="../js/requestFun.js" type="text/javascript" charset="utf-8"></script>
	<script>
		(function($, doc, $$, undefined) {
			$$.init();
			var _self,
				timer;
			if (window.plus) {
				plusReady();
			} else {
				doc.addEventListener('plusready', plusReady, false);
			}

			function plusReady() {
				plus.navigator.setFullscreen(false);
				//强制竖屏
				plus.screen.lockOrientation("portrait-primary");
				//强制隐藏滚动条
				// plus.webview.currentWebview().setStyle({ scrollIndicator: 'none' });
				_self = plus.webview.currentWebview();
				//是否可以点击【获取验证码按钮开关】
				var onOff = true,
					// UserSessionID = plus.storage.getItem("userSessionId");//获取存储的用户标识
					//code_4用于注册信息时的验证，验证码，获取与输入的一致
					code_4 = '';
				$('.getcode').on('tap', function() {
					//如果onOff标志false则，不执行任何操作
					if (!onOff)
						return;
					//循环周期60s
					var tel = $('#tel').val(),
						telReg = /^1[3,4,5,6,7,8,9]\d{9}$/,
						times = 6;
					//获取验证码
					//模拟短信发送，以后需要改成短信发送，在这里修改
					//发送短信验证码
					if (telReg.test(tel)) {
						// $$.ajax(requserUrl + '/user/getSmsCode', {
						// 	timeout: 20000,
						// 	type: 'post',
						// 	headers: {},
						// 	data: {
						// 		phone: tel,
						// 	},
						// 	success: function (data) {

						// 	},
						// 	error: function () {
						// 		console.log('接口完成')
						// 	}
						// })

						//使用定时器，一秒触发一次事件，如果结束，则关闭定时器
						timer = setInterval(function() {
							//事件处理，一秒一次
							times--;
							if (times < 1) {
								//执行结束，则可以再次点击
								$('.getcode').html("重新获取");
								onOff = true;
								clearInterval(timer);
							} else {
								var text = times + 's';
								$('.getcode').html(text);
								onOff = false;
							}
						}, 1000);
					} else {
						$$.toast('请输入正确的手机号码')
						return
					}

					// mui.toast(code);

				});
				//点击提交按钮跳转实名认证页
				$('.submit').on('tap', function() {
					var tel = $('#tel').val(),
						telReg = /^1[3,4,5,6,7,8,9]\d{9}$/,
						code = $('#code').val();
					if (!telReg.test(tel)) {
						$$.toast('请输入正确的手机号码')
						return
					} else if (code.length != 4) {
						$$.toast('请输入正确的验证码')
						return
					}
					$$.ajax(requserUrl + '/user/bindPhone', {
						timeout: 20000,
						type: 'post',
						data: {
							phone: tel,
							smsCode: code,
							appWeChatId: _self.powerId
						},
						success: function(data) {
							// console.log(JSON.stringify(data) + '看空间')
							if (data.code == 0) {
								if (data.attributes.sessionId) {
									plus.storage.setItem('userSessionId', data.attributes.sessionId + '');
									plus.storage.setItem('userId', data.attributes.userId + '');
								}
							} else {
								$$.toast(data.msg);
							}

							var verificationWait = plus.nativeUI.showWaiting();
							if (data.code == 0) {
								// 是否实名判断
								isRealName(data.attributes.sessionId, function(data) {
									console.log("成功:" + JSON.stringify(data));
									if (data.code == 0) {
										// plus.storage.setItem('userSessionId', data.attributes.sessionId);
										verificationWait.close();
										if (data.obj.realName == 0) {
											// 未实名
											var verTimer = setTimeout(function() {
												clearTimeout(verTimer);
												if (verificationWait) {
													verificationWait.close();
												}
												// 必须去实名
												$$.openWindow({
													url: "realName.html",
													id: "realName",
													styles: {
														statusbar: {
															background: '#008BD5'
														}
													},
													extras: {
														"onlyId": "1"
													},
													show: {
														aniShow: "slide-in-right", //页面显示动画，默认为”slide-in-right“；
													}
												});
											}, 100);
										} else if (data.obj.realName == 1) {
											// 存储用户实名信息
											plus.storage.setItem('realName', data.obj.realName);
											// 人脸识别判断
											if (data.obj.idFace == null) {
												if (verificationWait) {
													verificationWait.close();
												}
												$$.openWindow({
													url: "faceDescerm.html",
													id: "faceDescerm",
													styles: {
														statusbar: {
															background: '#008BD5'
														}
													},
													extras: {
														"onlyId": "2"
													},
													show: {
														aniShow: "slide-in-right", //页面显示动画，默认为”slide-in-right“；
													}
												});
											} else {
												// 存储用户人脸识别信息
												plus.storage.setItem('idFace', data.obj.idFace);
												if (plus.webview.getWebviewById("index-user-menu")) {
													plus.webview.getWebviewById("index-user-menu").close();
												}
												if (plus.webview.getWebviewById("userIndex.html")) {
													plus.webview.getWebviewById("userIndex.html").close();
												}
												login ? login.close() : '';
												verificationWait.close();
												var verTimer = setTimeout(function() {
													clearTimeout(verTimer);
													if (verificationWait) {
														plus.webview.currentWebview().close();
													}
													plus.webview.getLaunchWebview().reload(true); //首页窗口对象 
													if (plus.webview.getWebviewById("userIndex.html")) {
														plus.webview.getWebviewById("userIndex.html").reload(true);
													}
												}, 100);
											}
										} else {
											if (verificationWait) {
												verificationWait.close();
											}
											console.log("实名状态异常：" + JSON.stringify(data));
											_self.close();
										}
										timer = null;
									} else if (data.code == 300 || (data.code == 500 && data.msg == 'no_login')) {
										if (verificationWait) {
											verificationWait.close();
										}
										tipShow("请重新登录！");
										clearStorage();
										mui.openWindow({
											url: "../login.html",
											id: "login",
											show: {
												aniShow: "slide-in-right"
											}
										});
									} else {
										if (verificationWait) {
											verificationWait.close();
										}
										console.log(data.msg);
										_self.close();
									}
								});
							} else {
								if (verificationWait) {
									verificationWait.close();
								}
								_self.close();
							}
						},
						error: function(err) {
							verificationWait.close();
							acceptDateErrorTip();
						}
					})

				});
			}

		})(jQuery, document, mui);
	</script>

</html>
