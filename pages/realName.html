<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>my_setting</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/font-awesome.min.css">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/common.css">
		<link rel="stylesheet" href="../css/mobileReset.css">
		<link rel="stylesheet" href="../css/pages/reaiName.css" />
		<script src="../js/rem_reset.js"></script>
	</head>
	<body onselectstart="return false;">
		<header class="header_white">
			<i class="mui-action-back"><img src="../image/left@2x.png"></i>
			实名认证
		</header>
		<div class="content">
			<div class="" id="successImg" style="display: none;">
				<div class="success_img">
					<img src="../image/nameSuccess.png" class="width100">
				</div>
				<div class="font_color99 font_size26" style="margin-top: .7rem;">
					认证成功
				</div>
			</div>
			<!-- 图像识别别 -->
			<div id="realNameOne" style="display: none;">
				<div class="reaiName_card_title">
					<div class="reaiName_card_signL"></div>
					<div>请拍摄并上传您的身份证照片</div>
					<div class="reaiName_card_signR"></div>
				</div>
				<div style="display: flex;">
					<div class="_left" data-id='z'>
						<img src="../image/card@2x.png" style="width: 100%;" id="uploadImg1">
					</div>
					<div class="_left">
						<img src="../image/cardF@2x.png" style="width: 100%;" id="uploadImg2">
					</div>
				</div>
				<div style="display: flex;">
					<div class="font">
						拍摄正面
					</div>
					<div class="font">
						拍摄反面
					</div>
				</div>
				<div class="division"></div>
				<div class="reaiName_card_title">
					<div class="reaiName_division_signL"></div>
					<div>拍摄身份证要求</div>
					<div class="reaiName_division_signR"></div>
				</div>
				<div class="font_size26 font_margin">大陆公民持有本人有效二代身份证</div>
				<div class="font_size26">拍摄时确保身份证 <span>边框完整,</span><span>字体清晰,</span><span>亮度均匀</span></div>
				<div class="tips_moudel">
					<img src="../image/tipsCard@2x.png" width="100%">
				</div>

				<div class="bottom_btn" id="btnOne">
					下一步
				</div>
			</div>
			<!-- 信息确认 -->
			<div id="realNameTwo" style="display: none;">
				<div class="_one">
					<div class="_left">姓名</div>
					<div class="_right">
						<input type="text" placeholder="请填写姓名" id="name">
					</div>
				</div>
				<div class="_one">
					<div class="_left">身份证号</div>
					<div class="_right">
						<input type="text" placeholder="请填写身份证号" id="idCard">
					</div>
				</div>
				<div class="bottom_btn" id="btnTwo">
					下一步
				</div>
			</div>
			<!-- 信息录入 -->
			<div id="realNameThree" style="display: none;">
				<div class="_one">
					<div class="_left">持卡人</div>
					<div class="_right">
						<input type="text" placeholder="请填写姓名" id="name">
					</div>
				</div>
				<div class="_one">
					<div class="_left">卡号</div>
					<div class="_right">
						<input type="text" placeholder="请填写卡号" id="bankCardNumber">
					</div>
				</div>
				<div class="_one">
					<div class="_left">银行</div>
					<div class="_right" style="font-size: .3rem;color: #303030;line-height: 2;">
						<input type="" name="" id="bankName" value="" disabled />
					</div>
				</div>
				<div class="_one">
					<div class="_left">卡类型</div>
					<div class="_right" style="font-size: .3rem;color: #303030;line-height: 2;">
						<input type="" name="" id="cardType" value="" disabled />
					</div>
				</div>
				<div style="background-color: #F5F8FF;height: .2rem;float: left;width: 7.5rem;"></div>
				<div class="_one">
					<div class="_left">手机号</div>
					<div class="_right">
						<input type="text" placeholder="请输入银行预留手机号" id="bankPhone" maxlength="11">
					</div>
				</div>
				<div class="_one">
					<div class="_left_y">验证码</div>
					<div class="_right_i">
						<input type="text" id="cardCode" placeholder="请填写验证码" maxlength="6">
					</div>
					<div class="_right_yb" id="bankYzm">
						发送验证码
					</div>
				</div>
				<div class="bottom_btn" id="btnthree">
					完成
				</div>
			</div>
		</div>

	</body>
	<script src="../js/jquery-1.11.2.min.js"></script>
	<script src="../js/mui.min.js"></script>
	<script src="../js/requestFun.js"></script>
	<script src="../js/variousMethods.js"></script>
	<script src="../js/bankType.js"></script>
	<script src="../js/commonFun.js"></script>
	<script>
		(function($, doc, $$, undefined) {
			$$.init();
			var _self;
			if (window.plus) {
				plusReady();
			} else {
				doc.addEventListener('plusready', plusReady, false);
			}

			function plusReady() {
				plus.navigator.setFullscreen(false);
				//强制竖屏
				plus.screen.lockOrientation("portrait-primary");
				//强制隐藏滚动条
				plus.webview.currentWebview().setStyle({
					scrollIndicator: 'none'
				});
				_self = plus.webview.currentWebview();
				// 获取父及页面
				var openView = plus.webview.currentWebview().opener();
				//判断是否存在父窗口,存在则关闭
				if (openView.id == "bankCard") {
					openView.hide();
					openView.close();
				}

				//查询是否实名认证
				getUserDetail(mui, plus.storage.getItem('memberId'), function(data) {
					if (data.code == 200) {
						if (data.data.idcard) {
							$('#successImg').css('display','block')
						}else{
							$('#realNameOne').css('display','block')
						}
					} else if (data.code == 401 || data.code == 1500) {
						gotoLoginIn()
					} else {
						tipShow(data.message)
						$("#code").val('')
					}
				});

				/**
				 * 上传图片操作列表
				 * @param {object} dom 上传节点
				 */
				function upImgFun(dom) {
					if (mui.os.plus) {
						var a = [{
							title: "拍照"
						}, {
							title: "从手机相册选择"
						}];
						plus.nativeUI.actionSheet({
							title: "插入图片",
							cancel: "取消",
							buttons: a
						}, function(b) {
							switch (b.index) {
								case 0:
									break;
								case 1:
									getImage(dom); /*拍照*/
									break;
								case 2:
									galleryImg(dom); /*打开相册*/
									break;
								default:
									break;
							}
						})
					}
				}

				/**
				 * 拍照
				 * @param {object} dom 上传节点
				 */
				function getImage(dom, cameraIndex, callback) {
					if (cameraIndex) {
						var c = plus.camera.getCamera(cameraIndex);
					} else {
						var c = plus.camera.getCamera();
					}
					c.captureImage(function(e) {
						// 读取本地文件中选取图片
						plus.io.resolveLocalFileSystemURL(e, function(entry) {
							// 执行上传操作
							// console.log(entry.toLocalURL());
							compressImage(entry.toLocalURL(), dom, callback)
						}, function(e) {
							plus.nativeUI.toast("读取拍照文件错误：" + e.message);
							callback && callback(500);
						});
					}, function(s) {
						console.log("error" + s);
						callback && callback(500);
					}, {
						filename: "_doc/head.jpg"
					})
				}
				/**
				 * 手机相册选择
				 * @param {object} dom 上传节点
				 */
				function galleryImg(dom) {
					plus.gallery.pick(function(a) {
						plus.io.resolveLocalFileSystemURL(a, function(entry) {
							//entry为图片原目录（相册）的句柄
							upImg(entry.toLocalURL(), dom);
						}, function(e) {
							console.log("读取图片错误：" + e.message);
						});
					}, function(a) {}, {
						filter: "image"
					})
				}

				// 压缩图片
				function compressImage(imgUrl, dom, callback) {
					console.log("开始压缩图片：")
					plus.nativeUI.showWaiting();
					// console.log(imgUrl);
					plus.zip.compressImage({
							src: imgUrl,
							dst: imgUrl,
							quality: 20,
							overwrite: true,
							width: '80%'
						},
						function(i) {
							plus.nativeUI.closeWaiting();
							console.log("压缩图片成功：" + JSON.stringify(i));
							imgUrlY = i.target
							upImg(imgUrlY, dom, callback);
							return
						},
						function(e) {
							plus.nativeUI.closeWaiting();
							console.log("压缩图片失败: " + JSON.stringify(e));

						});
				}
				/**
				 * 图片上传
				 * @param {object} dom 上传节点
				 */
				function upImg(event, dom, callback) {
					console.log(JSON.stringify(event))
					if (_self.imgId == 'z') {
						var server = requserUrl + '/mb/verificPositive';
						$("#uploadImg1").attr("src", event);
					} else {
						var server = requserUrl + '/mb/verificNegative';
						$("#uploadImg2").attr("src", event);
					}
					var wt = plus.nativeUI.showWaiting("上传中...");
					var uploaderDown = plus.uploader.createUpload(server, {
							method: "post"
						},
						function(t, status) {
							wt.close();
							var dataCode = eval("(" + t.responseText + ")")
							console.log(JSON.stringify(dataCode))
							if (dataCode.code == '200') {
								if (_self.imgId == 'z') {
									$('#name').val(dataCode.data.name)
									$('#idCard').val(dataCode.data.idcard)
								}

							} else {
								alert(dataCode.message)
							}

						});
					uploaderDown.addFile(event, {
						key: "file"
					}); //添加传输文件 event 文件  key 文件夹名
					uploaderDown.setRequestHeader('Authorization', "Bearer" + " " + plus.storage.getItem('Token'));
					uploaderDown.setRequestHeader('client', 'APP');
					uploaderDown.addData("string_key", "string_value");
					uploaderDown.start()
				}
				//提示
				function tipShow(str) {
					plus.nativeUI.toast(str, {
						duration: "short",
						verticalAlign: "center"
					});
				}

				// 点击上传图片
				$('._left').on('tap', function() {
					var _this = $(this);
					_self.imgId = $(this).attr('data-id')
					setTimeout(function() {
						upImgFun(_this);
					}, 50);
				})
				// 图像识别点击下一步
				$('#btnOne').on('tap', function() {
					$('#realNameOne').css('display', 'none')
					$('#realNameTwo').css('display', 'block')
				});
				// 姓名识别点击下一步
				$('#btnTwo').on('tap', function() {
					var keyword = {
						id: plus.storage.getItem('memberId'),
						idcard: $('#idCard').val(),
						name: $('#name').val(),
					}
					getSaveVerific(mui, keyword, function(data) {
						if (data.code == 200) {
							// 查询银行卡列表
							getBankFindAll(mui, plus.storage.getItem('memberId'), function(data) {
								console.log(JSON.stringify(data) + '银行卡')
								if (data.code == 200) {
									if (data.data.length > 0) {
										$('#realNameOne').css('display', 'block')
										$('#realNameTwo').css('display', 'none')
										$('#realNameThree').css('display', 'none')
									} else {
										$('#realNameOne').css('display', 'none')
										$('#realNameTwo').css('display', 'none')
										$('#realNameThree').css('display', 'block')
									}
								} else {
									tipShow(data.message)
								}
							});

						} else {
							tipShow(data.message)
						}
					});
				})
				// 添加银行卡保存
				$('#btnthree').on('tap', function() {
					if (!$('#name').val()) {
						tipShow('请检查姓名')
						return;
					} else if (luhnCheck($('#bankCardNumber').val())) {
						tipShow('请检查银行卡')
						return;
					}
					var keyword = {
						name: $('#name').val(),
						bankCard: $('#bankCardNumber').val(), //银行卡
						bankName: $('#bankName').val(), //银行开户行名称
						bankType: $('#cardType').val(), //	银行卡类型
						memberId: plus.storage.getItem('memberId'), //
						reservedMobile: $('#bankPhone').val(), //银行预留手机号
					}
					getBankSave(mui, keyword, $('#cardCode').val(), function(data) {
						if (data.code == 200) {
							location.reload();
						} else {
							tipShow(data.message)
						}
					})
				})
				//点击获取验证码
				var yzm = document.getElementById('bankYzm')
				//是否可以点击【获取验证码按钮开关】
				var onOff = true;
				var reg = new RegExp(/^\d{6}$/); //6位数字验证
				//code_4用于注册信息时的验证，验证码，获取与输入的一致
				var code_4 = '';
				yzm.onclick = function() {
					if ($('#bankPhone').val() < 11) {
						tipShow('请输入正确手机号')
						return
					}
					//如果onOff标志false则，不执行任何操作
					if (!onOff)
						return;
					//循环周期60s
					var times = 60;
					//获取验证码
					var data1 = {
						phone: $('#bankPhone').val()
					};
					getCode(mui, data1, function(data) {
						if (data.code == 200) {
							console.log('验证码获取成功' + data.data)
						} else {
							console.log('验证码获取失败' + data.message)
						}
					});
					//使用定时器，一秒触发一次事件，如果结束，则关闭定时器
					var timer = setInterval(function() {
						//事件处理，一秒一次
						times--;
						if (times < 1) {
							//执行结束，则可以再次点击
							yzm.innerHTML = "重新获取";
							onOff = true;
							clearInterval(timer);
						} else {
							var text = times + 's';
							yzm.innerHTML = text;
							onOff = false;
						}
					}, 1000);
				}
				// 监听银行卡号
				$('#bankCardNumber').bind('input propertychange', function() {
					if ($(this).val().length == 16 || $(this).val().length == 19) {
						if (luhnCheck($(this).val())) {
							$('#bankName').val(bankCardAttribution($(this).val()).bankName)
							$('#cardType').val(bankCardAttribution($(this).val()).cardTypeName)
						} else {
							tipShow('请检查银行卡号')
							$('#bankName').val()
							$('#cardType').val()
						}
					}
				});

			}
		})(jQuery, document, mui);
	</script>

</html>
