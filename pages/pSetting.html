<!DOCTYPE html>
<html>
	<head>
		<!-- 时间选择弹框 -->
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />

		<meta charset="utf-8">
		<title>my_setting</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
		<!-- <meta name="apple-mobile-web-app-status-bar-style" content="black"> -->
		<link rel="stylesheet" href="../css/font-awesome.min.css">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/common.css">
		<link rel="stylesheet" href="../css/mui.dtpicker.css" />
		<link rel="stylesheet" href="../css/pages/myAddress.css" type="text/css" />

		<script src="../js/rem_reset.js"></script>

		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="../css/app.css" />
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />

		<!-- 引入外部css -->
		<link rel="stylesheet" type="text/css" href="../css/pages/pSetting.css" />

	</head>
	<body onselectstart="return false;">
		<header class="header_white title">
			<i class="mui-action-back" style="touch-action: none;"><img src="../image/returnButton.png" style="width: .22rem;height: .38rem;"></i>
			个人资料设置
		</header>
		<div class="content contentList">
			<div id='addressEditor'>
				<div class="_one rowClass" style="width: 7rem;">
					<div class="_left" style="width: 1.5rem;">头像</div>
					<div class="_right iIoc">
						<input onfocus='this.blur();' readonly="readonly" type="text" />
						<img id="imgPara" data-id='z'>
					</div>
				</div>
				<div class="_one rowClass" style="width: 7rem;">
					<div class="_left" style="width: 1.5rem;">用户名</div>
					<div class="_right iIoc">
						<input onfocus='this.blur();' readonly="readonly" id="namepara" type="text" placeholder="请填写收货人姓名">
						<i id="nameIoc" class="fa fa-angle-right"></i>
					</div>
				</div>
				<div class="_one rowClass" style="width: 7rem;">
					<div class="_left" style="width: 1.5rem;">手机号</div>
					<div class="_right iIoc">
						<input onfocus='this.blur();' readonly="readonly" id="phoneParaTwo" type="text" placeholder="请填写收货人手机号">
						<i id="phoneIoc" class="fa fa-angle-right"></i>
					</div>
				</div>

				<div class="_one rowClass" style="width: 7rem;">
					<div class="_left" style="width: 1.5rem;">性别</div>
					<div class="_right iIoc">
						<input onfocus='this.blur();' readonly="readonly" id='userResult' type="text" placeholder="请填写收货人性别"></output>
						<i id='showUserPicker' class="fa fa-angle-right"></i>
					</div>
				</div>
				<div class="_one rowClass" style="width: 7rem;">
					<div class="_left" style="width: 1.5rem;">生日</div>
					<div class="_right iIoc">
						<input onfocus='this.blur();' readonly="readonly" id='result' type="text" placeholder="请填写收货人生日"></output>
						<i id="sr" data-options='{"type":"date","beginYear":1960,"endYear":2020}' class="btn fa fa-angle-right"></i>
					</div>
				</div>
				<div class="_one rowClass" style="width: 7rem;">
					<div class="_left" style="width: 1.5rem;">纪念日</div>
					<div class="_right iIoc">
						<input onfocus='this.blur();' readonly="readonly" id="resultTwo" type="text" placeholder="请填写收货人纪念日">
						<i id="jnr" data-options='{"type":"monthday"}' class="btn fa fa-angle-right"></i>
					</div>
				</div>
			</div>
		</div>
		<!-- 修改提示 -->
		<div class="bj_model" style="display: none;">
			<div class="pSetting_change_model text_center">
				<div class=" font_size28 font_color00 font_width900">
					请核对以下信息
				</div>
				<div style="border-bottom: 1px solid #FFFFFF;box-shadow: 1px 1px 2px 0px #d4cfcf;"></div>
				<div class=" font_size36 font_color00  margin_top5" id="birthdayN">
					1989-07-21
				</div>
				<div class="font_colorf4 font_size20 margin_top5">
					*<span id="dayEv">纪念日</span> 1年只能修改一次
				</div>
				<div class="font_size28 font_colorff div_display margin_top4">
					<div class="div_backgroun_jb text_center pSetting_btn" id="modelClose">
						重新填写
					</div>
					<div class="div_backgroun_jb text_center pSetting_btn" id="okBtn">
						确认无误
					</div>
				</div>
			</div>
		</div>

	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/jquery-1.11.2.min.js"></script>
	<script src="../js/mui.picker.min.js"></script>
	<script src="../js/mui.picker.js"></script>
	<script src="../js/mui.dtpicker.js"></script>
	<script src="../js/mui.poppicker.js"></script>
	<script src="../js/city.data.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/requestFun.js" type="text/javascript"></script>
	<script>
		(function($, doc) {
			$.init();
			var _self;
			if (window.plus) {
				plusReady();
			} else {
				doc.addEventListener('plusready', plusReady, false);
			}

			/* 获取到的生日时间  赋值 */
			var result = doc.getElementById('result');
			var resultTwo = doc.getElementById('resultTwo');
			var btns = $('.btn');
			var idPara = "";

			function plusReady() {
				plus.navigator.setFullscreen(false);
				//强制竖屏
				plus.screen.lockOrientation("portrait-primary");
				//强制隐藏滚动条
				plus.webview.currentWebview().setStyle({
					scrollIndicator: 'none'
				});
				_self = plus.webview.currentWebview();
				/**
				 * 上传图片操作列表
				 * @param {object} dom 上传节点
				 */
				function upImgFun(dom) {
					if (mui.os.plus) {
						var a = [{
							title: "拍照"
						}, {
							title: "从手机相册选择"
						}];
						plus.nativeUI.actionSheet({
							title: "插入图片",
							cancel: "取消",
							buttons: a
						}, function(b) {
							switch (b.index) {
								case 0:
									break;
								case 1:
									getImage(dom); /*拍照*/
									break;
								case 2:
									galleryImg(dom); /*打开相册*/
									break;
								default:
									break;
							}
						})
					}
				}

				/**
				 * 拍照
				 * @param {object} dom 上传节点
				 */
				function getImage(dom, cameraIndex, callback) {
					if (cameraIndex) {
						var c = plus.camera.getCamera(cameraIndex);
					} else {
						var c = plus.camera.getCamera();
					}
					c.captureImage(function(e) {
						// 读取本地文件中选取图片
						plus.io.resolveLocalFileSystemURL(e, function(entry) {
							// 执行上传操作
							compressImage(entry.toLocalURL(), dom, callback)
						}, function(e) {
							plus.nativeUI.toast("读取拍照文件错误：" + e.message);
							callback && callback(500);
						});
					}, function(s) {
						console.log("error" + s);
						callback && callback(500);
					}, {
						filename: "_doc/head.jpg"
					})
				}


				/**
				 * 图片上传
				 * @param {object} dom 上传节点
				 */
				function upImg(event, dom, callback) {
					var server = requserUrl + '/mb/uploadAvatar/' + plus.storage.getItem('memberId');
					var wt = plus.nativeUI.showWaiting("上传中...");
					var uploaderDown = plus.uploader.createUpload(server, {
							method: "post"
						},
						function(t, status) {
							wt.close();
							var dataCode = eval("(" + t.responseText + ")")
							if (dataCode.code == '200') {
								document.getElementById("imgPara").src = dataCode.data;
							} else {
								alert(dataCode.message)
							}

						});
					uploaderDown.addFile(event, {
						key: "file"
					}); //添加传输文件 event 文件  key 文件夹名
					uploaderDown.setRequestHeader('Authorization', "Bearer" + " " + plus.storage.getItem('Token'));
					uploaderDown.setRequestHeader('client', 'APP');
					uploaderDown.addData("string_key", "string_value");
					uploaderDown.start()
				}


				/**
				 * 手机相册选择
				 * @param {object} dom 上传节点
				 */
				function galleryImg(dom) {
					plus.gallery.pick(function(a) {
						plus.io.resolveLocalFileSystemURL(a, function(entry) {
							//entry为图片原目录（相册）的句柄
							upImg(entry.toLocalURL(), dom);
						}, function(e) {
							console.log("读取图片错误：" + e.message);
						});
					}, function(a) {}, {
						filter: "image"
					})
				}

				// 压缩图片
				function compressImage(imgUrl, dom, callback) {
					console.log("开始压缩图片：")
					plus.nativeUI.showWaiting();
					// console.log(imgUrl);
					plus.zip.compressImage({
							src: imgUrl,
							dst: imgUrl,
							quality: 20,
							overwrite: true,
							width: '80%'
						},
						function(i) {
							plus.nativeUI.closeWaiting();
							console.log("压缩图片成功：" + JSON.stringify(i));
							imgUrlY = i.target
							upImg(imgUrlY, dom, callback);
							return
						},
						function(e) {
							plus.nativeUI.closeWaiting();
							console.log("压缩图片失败: " + JSON.stringify(e));

						});
				}


				// 点击上传图片
				var phoneIoc = doc.getElementById('imgPara');
				phoneIoc.addEventListener('tap', function(event) {
					var _this = $(this);
					/* _self.imgId = $(this).attr('data-id') */
					setTimeout(function() {
						upImgFun(_this);
					}, 50);
				})




				/* 接收传过来的用户名，并且赋值 */
				if (_self.namepara) {
					result.value = _self.namepara;
				}

				/* 请求接口获取用户个人信息 */
				var phonePara = doc.getElementById('phoneParaTwo');
				var namepara = doc.getElementById("namepara");
				var imgPara = "../image/log@2x.png";

				if (plus.storage.getItem('Token')) {
					getUserList(mui, plus.storage.getItem('memberId'), function(data) {
						//alert("111");
						if (data.code == 200) {
							idPara = data.data.id;
							if (data.data.avatar) {
								if (data.data.avatar.length > 40) {
									imgPara = data.data.avatar;
								}
							}

							document.getElementById("imgPara").src = imgPara;
							namepara.value = data.data.nickname;
							var tele = data.data.mobile;
							_self.phonePara = data.data.mobile;
							//alert("222");
							phonePara.value = tele.substring(3, 0) + "^_^" + tele.substring(7, 11);
							if (data.data.sex == 0) {
								userResult.value = "";
							} else {
								//doc.getElementById("showUserPicker").style.visibility = "hidden";
								var setPara = "";
								if (data.data.sex == "1") {
									setPara = "男";
								} else {
									setPara = "女";
								}
								userResult.value = setPara;
							}

							if (data.data.birthday) {
								//doc.getElementById("sr").style.visibility = "hidden";
							}
							result.value = data.data.birthday;

							if (data.data.rememberDay) {
								doc.getElementById("jnr").style.visibility = "hidden";
							}
							resultTwo.value = data.data.rememberDay;
						} else {
							if (data.message == "当前用户未登录") {
								$.openWindow({
									url: '../index.html',
									id: 'index',
									show: {
										aniShow: "slide-in-right"
									}
								});
								return;
							}
						}
					})
				} else {
					tipShow("没有Token");
				};

				window.addEventListener('refreshMajorGuestCount', function(event) {
					getUserList(mui, plus.storage.getItem('memberId'), function(data) {
						if (data.code == 200) {
							idPara = data.data.id;
							if (data.data.avatar.length > 40) {
								imgPara = data.data.avatar;
							}
							document.getElementById("imgPara").src = imgPara;
							namepara.value = data.data.nickname;
							var mobile = data.data.mobile;
							phonePara.value = mobile.substring(3, 0) + "^_^" + mobile.substring(7, 11);
							if (data.data.sex == 0) {
								userResult.value = "";
							} else {
								userResult.value = data.data.sex;
							}
							result.value = data.data.birthday;
							resultTwo.value = data.data.rememberDay;
						} else {
							tipShow(data.message);
						}
					})
				});

				/* 设置用户名 跳页面传参数 */
				var nameIoc = doc.getElementById('nameIoc');
				nameIoc.addEventListener('tap', function(event) {
					$.openWindow({
						url: 'updateName.html',
						id: 'updateName',
						extras: {
							"namepara": namepara.value,
							"idPara": idPara,
						},
						show: {
							aniShow: "slide-in-right"
						}
					});
				}, false);

				/* 更改手机号*/
				var phoneIoc = doc.getElementById('phoneIoc');
				phoneIoc.addEventListener('tap', function(event) {
					$.openWindow({
						url: 'updatePhone.html',
						id: 'updatePhone',
						extras: {
							"phonePara": _self.phonePara,
							"idPara": idPara,
						},
						show: {
							aniShow: "slide-in-right"
						}
					});
				}, false);
			}
			// 关闭弹出框
			jQuery('#modelClose').on('tap', function() {
				jQuery('.bj_model').css('display', 'none');
			})
			// 确认无误
			jQuery('#okBtn').on('tap', function() {
				var dataBase = {};
				if (jQuery('#birthdayN').text().length < 7) {
					resultTwo.value = jQuery('#birthdayN').text();
					/* 纪念日 */
					dataBase = {
						rememberDay: jQuery('#birthdayN').text(),
						id: idPara,
					};
				} else {
					result.value = jQuery('#birthdayN').text();
					/* 生日 */
					dataBase = {
						birthday: jQuery('#birthdayN').text(),
						id: idPara,
					};
				}
				/* 调用接口保存日期*/
				updateName(mui, dataBase, function(data) {
					//alert("444")
					if (data.code == 200) { //纪念日
						if (jQuery('#birthdayN').text().length < 7) {
							resultTwo.value = jQuery('#birthdayN').text();
							jQuery('.bj_model').css('display', 'none');
							doc.getElementById("jnr").style.visibility = "hidden";
						} else { //生日
							//alert("555");
							result.value = jQuery('#birthdayN').text();
							//doc.getElementById("sr").style.visibility = "hidden";
						}
						//jQuery('.bj_model').css('display', 'none');
						//plus.webview.getWebviewById('pSetting').reload()
					} else {
						tipShow(data.message);
					}
				})

			})
			/* 日期 */
			btns.each(function(i, btn) {
				btn.addEventListener('tap', function() {
					var _self = this;
					if (_self.picker) {
						_self.picker.show(function(rs) {
							var dataBase = {};
							if (rs.text.length < 7) {
								//alert("11")
								resultTwo.value = rs.text;
								/* 纪念日 */
								dataBase = {
									rememberDay: rs.text,
									id: idPara,
								};

							} else {
								result.value = rs.text;
								//alert("12")
								/* 生日 */
								dataBase = {
									birthday: rs.text,
									id: idPara,
								};

							}

							/* 调用接口保存性别 */
							updateName(mui, dataBase, function(data) {
								if (data.code == 200) {
									if (rs.text.length < 7) { //纪念日
										//alert("13")
										resultTwo.value = rs.text;
										doc.getElementById("jnr").style.visibility = "hidden";
									} else { //生日
										//alert("14")
										result.value = "";
										result.value = rs.text;
										//doc.getElementById("sr").style.visibility = "hidden";
									}
								} else {
									tipShow(data.message);
								}
							})
							_self.picker.dispose();
							_self.picker = null;
						});
					} else {
						var optionsJson = this.getAttribute('data-options') || '{}';
						var options = JSON.parse(optionsJson);
						var id = this.getAttribute('id');
						_self.picker = new $.DtPicker(options);
						_self.picker.show(function(rs) {
							if (rs.text.length < 7) {
								//alert("15")
								jQuery('#dayEv').text('纪念日')
								jQuery('.bj_model').css('display', 'block');
								jQuery('#birthdayN').text(rs.text);
								
								_self.picker.dispose();
								_self.picker = null;
							} else {
								//alert("16")
								result.value = rs.text;
								jQuery('#dayEv').text('生日')
							}
						});
					}

				}, false);
			});
			/* 性别选择提示框 */
			var userPicker = new $.PopPicker();
			userPicker.setData([{
				value: '1',
				text: '男'
			}, {
				value: '2',
				text: '女'
			}]);
			var showUserPickerButton = doc.getElementById('showUserPicker');
			var userResult = doc.getElementById('userResult');
			showUserPickerButton.addEventListener('tap', function(event) {
				userPicker.show(function(items) {
					userResult.value = items[0].text;
					/* 调用接口保存性别 */
					var dataBase = {
						sex: items[0].value,
						id: idPara,
					};
					updateName(mui, dataBase, function(data) {
						if (data.code == 200) {
							//doc.getElementById("showUserPicker").style.visibility = "hidden";
						} else {
							tipShow(data.message);
						}
					})
				});
			}, false);
		})(mui, document);
	</script>

</html>
