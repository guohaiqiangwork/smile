<!DOCTYPE html>
<html>
	<head>
		<!-- 时间选择弹框 -->
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
		
		<meta charset="utf-8">
		<title>my_setting</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
		<!-- <meta name="apple-mobile-web-app-status-bar-style" content="black"> -->
		<link rel="stylesheet" href="../css/font-awesome.min.css"> 
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/common.css">
		<link rel="stylesheet" href="../css/mui.dtpicker.css"/> 
		<link rel="stylesheet" href="../css/pages/myAddress.css" type="text/css" />

		<script src="../js/rem_reset.js"></script>
		
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<!--App自定义的css-->
<!-- 		<link rel="stylesheet" type="text/css" href="../css/app.css" />
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" /> -->
		
		<!-- 引入外部css -->
		<link rel="stylesheet" type="text/css" href="../css/pages/updatePhone.css"/>
		
	</head>
	<body onselectstart="return false;">
		<header class="header_white title">
			<i class="mui-action-back"><img src="../image/left@2x.png"></i>
			更换手机号
		</header>
		<div class="content contentList">
			<div id='addressEditor'>
				<div class="_one rowClass" style="width: 7rem;">
					<div class="_right iIoc">
						<input id="phonePara" type="text" placeholder="请输入验证手机号码">
					</div>
				</div>
				<div class="_one rowClass" style="width: 7rem;">
					<div class="_right" style="width: 3rem;">
						<input id='userResult' type="text" placeholder="请输入验证码">
					</div>
					<div type="button" id="yzm">获取验证码</div>
				</div>
				<div>
					<button id="insertName" type="button">确认更换</button>
				</div>
			</div>
		</div>
		
	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/mui.picker.min.js"></script>
	<script src="../js/mui.picker.js"></script>
	<script src="../js/mui.dtpicker.js"></script>
	<script src="../js/mui.poppicker.js"></script>
	<script src="../js/city.data.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
	         <script src="../js/commonFun.js" type="text/javascript"></script>
	
	<script src="../js/requestFun.js" type="text/javascript"></script>
	<script>
		(function($, doc) {
			$.init();
			var _self;
			if (window.plus) {
				plusReady();
			} else {
				doc.addEventListener('plusready', plusReady, false);
			}
		
		
		function plusReady() {
			plus.navigator.setFullscreen(false);
			//强制竖屏
			plus.screen.lockOrientation("portrait-primary");
			//强制隐藏滚动条
			plus.webview.currentWebview().setStyle({
				scrollIndicator: 'none'
			});
			_self = plus.webview.currentWebview();
			
			var phonePara = doc.getElementById('phonePara');
			phonePara.value = _self.phonePara;
			
			//点击获取验证码
			var yzm = document.getElementById('yzm');
			//是否可以点击【获取验证码按钮开关】
			var onOff = true;
			var reg = new RegExp(/^\d{6}$/); //6位数字验证
			//code_4用于注册信息时的验证，验证码，获取与输入的一致
			var code_4 = '';
			yzm.onclick = function() {
				if (phonePara.value.length < 11) {
					tipShow('请输入正确手机号')
					return
				};
				//如果onOff标志false则，不执行任何操作
				if (!onOff)
					return;
				//循环周期60s
				var times = 60;
				//获取验证码
				var data1 = {
					phone: phonePara.value
				};
				var getCodeWati = plus.nativeUI.showWaiting("获取中...");
				getCode(mui, data1, function(data) {
					getCodeWati.close();
					if (data.code == 200) {
						console.log('验证码获取成功' + data.data)
					} else {
						console.log('验证码获取失败' + data.message)
					}
				});
				//使用定时器，一秒触发一次事件，如果结束，则关闭定时器
				var timer = setInterval(function() {
					//事件处理，一秒一次
					times--;
					if (times < 1) {
						//执行结束，则可以再次点击
						yzm.innerHTML = "重新获取";
						onOff = true;
						clearInterval(timer);
					} else {
						var text = times + 's';
						yzm.innerHTML = text;
						onOff = false;
					}
				}, 1000);
			};
			
			
			/* 更改手机号 */
			var insertName = doc.getElementById("insertName");
			var userResult = doc.getElementById("userResult");
			insertName.onclick = function(){
				if(!phonePara.value){
					tipShow("请填写手机号");
					return;
				}
				alert("11="+phonePara.value.length )
				if(phonePara.value.length < 11){
					tipShow("请填写正确手机号");
					return;
				}
				if(phonePara.value == _self.phonePara){
					tipShow("手机号没有更改");
					return;
				}
				if(!userResult.value){
					tipShow("请填写验证码");
					return;
				}
				
				/* 请求接口更改手机号 */
				var dataBase = {
					code: userResult.value.replace(/\s*/g,""),
					mobile: phonePara.value.replace(/\s*/g,""),
					memberId: plus.storage.getItem('memberId')
				};
				updateMobile(mui, dataBase, function(data) {
				    if (data.code == 200) {
						/* 手机号修改成功 */
						mui.alert('保存成功！', '提示', function() {
							plus.nativeUI.closeWaiting();
							mui.back();
						    var list = plus.webview.currentWebview().opener();　
						    mui.fire(list, 'refreshMajorGuestCount');
						});
				    } else {
				        tipShow(data.message);
				    }
				})
				
			}
		}		
	})(mui, document);
	</script>

</html>
