<!DOCTYPE html>
<html>
	<head>
		<!-- 时间选择弹框 -->
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />

		<meta charset="utf-8">
		<title>my_setting</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/common.css">
		<link rel="stylesheet" href="../css/pages/myAddress.css" type="text/css" />
		<script src="../js/rem_reset.js"></script>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="../css/app.css" />
		
		<link rel="stylesheet" type="text/css" href="../css/pages/cashPassword.css"/>

	</head>
		<header class="header_white title">
			<i class="mui-action-back"><img src="../image/left@2x.png" style="width: .22rem;height: .38rem;"></i>
			提现密码设置
		</header>
		<div class="content contentList">
			<div id='addressEditor'>
				<div class="_one rowClass" style="width: 6.5rem;">
					<div class="_left">手机号</div>
					<div class="_right iIoc" style="width: 4rem;">
						<input onfocus='this.blur();' style="color: #A0A0A0;" readonly="readonly"  id="phonePara" type="text" placeholder="请填写手机号">
					</div>
				</div>
				<div class="_one rowClass" style="width: 6.5rem;">
					<div class="_left">验证码</div>
					<div class="_right iIoc" style="width: 2.5rem;">
						<input id='userResult' type="text" placeholder="请输入验证码">
					</div>
					<div type="button" id="yzm">获取验证码</div>
				</div>
				<div class="_one rowClass" style="width: 6.5rem;">
					<div class="_left">新密码</div>
					<div class="_right iIoc" style="width: 4rem;">
						<input id="newPassWord" type="password" placeholder="请填写新密码" oninput = "value=value.replace(/[^\d]/g,'')">
					</div>
				</div>
				<div class="_one rowClass" style="width: 6.5rem;">
					<div class="_left">确认密码</div>
					<div class="_right iIoc" style="width: 4rem;">
						<input id="newPassWordTwo" type="password" placeholder="请您确认密码" oninput = "value=value.replace(/[^\d]/g,'')">
					</div>
				</div>
			</div>
			<div id="inserPassword">
				<button id="insertName" type="button">保存</button>
			</div>
		</div>

	</body>
	<script src="../js/jquery-1.11.2.min.js"></script>
	<script src="../js/mui.min.js"></script>
	<script src="../js/commonFun.js" type="text/javascript"></script>
	<script src="../js/requestFun.js" type="text/javascript"></script>
	<script src="../js/rem_reset.js"></script>
	
	<script>
		(function($, doc, $$, undefined) {
			$$.init();
			var _self;
			if (window.plus) {
				plusReady();
			} else {
				doc.addEventListener('plusready', plusReady, false);
			}

			function plusReady() {
				plus.navigator.setFullscreen(false);
				//强制竖屏
				plus.screen.lockOrientation("portrait-primary");
				//强制隐藏滚动条
				plus.webview.currentWebview().setStyle({
					scrollIndicator: 'none'
				});
				_self = plus.webview.currentWebview();
				
				/* *
				* 点击获取验证码 
				* 
				* */
				var yzm = document.getElementById('yzm')
				var phonePara = doc.getElementById('phonePara');
				//是否可以点击【获取验证码按钮开关】
				var onOff = true;
				var reg = new RegExp(/^\d{6}$/); //6位数字验证
				//code_4用于注册信息时的验证，验证码，获取与输入的一致
				var code_4 = '';
				yzm.onclick = function() {
					if (phonePara.value.length < 11) {
						tipShow('请输入正确手机号')
						return
					}
					//如果onOff标志false则，不执行任何操作
					if (!onOff)
						return;
					//循环周期60s
					var times = 60;
					//获取验证码
					var data1 = {
						phone: phonePara.value
					};
					var getCodeWati = plus.nativeUI.showWaiting("获取中...");
					getCode(mui, data1, function(data) {
						getCodeWati.close();
						if (data.code == 200) {
							console.log('验证码获取成功' + data.data)
						} else {
							console.log('验证码获取失败' + data.message)
						}
					});
					//使用定时器，一秒触发一次事件，如果结束，则关闭定时器
					var timer = setInterval(function() {
						//事件处理，一秒一次
						times--;
						if (times < 1) {
							//执行结束，则可以再次点击
							yzm.innerHTML = "重新获取";
							onOff = true;
							clearInterval(timer);
						} else {
							var text = times + 's';
							yzm.innerHTML = text;
							onOff = false;
						}
					}, 1000);
				};
				
				
				/* 获取用户手机号 */
				getUserList(mui, plus.storage.getItem('memberId'), function(data) {
				    if (data.code == 200) {
						if(data.data.mobile){
							phonePara.value = data.data.mobile;
						}else{
							phonePara.value = "无注册手机号";
						}
						
				    } else {
						if(data.message == "当前用户未登录"){
							$.openWindow({
								url: '../index.html',
								id: 'index',
								show: {
									aniShow: "slide-in-right"
								}
							});
							return;
						}
				    }
				})
				
				
				/**
				 * 修改支付密码
				 * 
				 * */
				 var insertName = document.getElementById('insertName');
				 var userResult = doc.getElementById('userResult');
				 var newPassWord = doc.getElementById('newPassWord');
				 var newPassWordTwo = doc.getElementById('newPassWordTwo');
				 insertName.onclick = function(){
					if(!phonePara.value){
						tipShow("请填写手机号");
						return;
					};
					if (phonePara.value.length < 11) {
						tipShow('请输入正确手机号')
						return
					}
					if(!userResult.value){
						tipShow("请填写验证码");
						return;
					};
					if(!newPassWord.value){
						tipShow("请填写新密码");
						return;
					};
					if(newPassWord.value.length > 6){
						tipShow("密码不能大于6位");
						return;
					};
					if(!newPassWordTwo.value){
						tipShow("请填写确认密码");
						return;
					};
					
					if(newPassWord.value != newPassWordTwo.value){
						tipShow("请确保密码一致");
						return;
					};
					 
					
					/**
					* 请求接口设置支付密码
					* */
					 
					var dataBase = {
						code: userResult.value.replace(/\s*/g,""),
						mobile: phonePara.value.replace(/\s*/g,""),
						memberId: plus.storage.getItem('memberId'),
						password:newPassWord.value,
					};
					updatePassword(mui, dataBase, function(data) {
					    if (data.code == 200) {
							/* 手机号修改成功 */
							mui.alert('保存成功！', '提示', function() {
								plus.nativeUI.closeWaiting();
								mui.back();
							    var list = plus.webview.currentWebview().opener();　
							    mui.fire(list);
							}); 
					    } else {
					        tipShow(data.message);
					    }
					}); 
				 }
				 
			}
		})(jQuery, document, mui);
	</script>

</html>
